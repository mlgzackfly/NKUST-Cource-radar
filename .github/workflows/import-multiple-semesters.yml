name: Import Multiple Semesters

on:
  # åƒ…æ”¯æ´æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      semesters:
        description: 'è¦åŒ¯å…¥çš„å­¸æœŸï¼ˆæ ¼å¼: 113-1,113-2,114-1ï¼‰'
        required: true
        default: '113-1,113-2,114-1'
        type: string
      scrape_syllabus:
        description: 'æ˜¯å¦çˆ¬å–èª²ç¨‹å¤§ç¶± (æœƒå¢åŠ  3-5 å€æ™‚é–“)'
        required: false
        default: false
        type: boolean

jobs:
  import-multiple:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 å°æ™‚è¶…æ™‚é™åˆ¶

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ“š Parse semesters
        id: parse
        run: |
          SEMESTERS="${{ inputs.semesters }}"
          echo "semesters=$SEMESTERS" >> $GITHUB_OUTPUT

          # è¨ˆç®—å­¸æœŸæ•¸é‡
          COUNT=$(echo "$SEMESTERS" | tr ',' '\n' | wc -l)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          echo "æº–å‚™åŒ¯å…¥ $COUNT å€‹å­¸æœŸ: $SEMESTERS"

      - name: ğŸ•·ï¸ Import semesters
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NKUST_SCRAPE_SYLLABUS: ${{ inputs.scrape_syllabus }}
        run: |
          SEMESTERS="${{ steps.parse.outputs.semesters }}"
          SCRAPE_SYLLABUS="${{ inputs.scrape_syllabus }}"

          echo "é–‹å§‹æ‰¹æ¬¡åŒ¯å…¥..."
          echo "çˆ¬å–èª²ç¨‹å¤§ç¶±: $SCRAPE_SYLLABUS"
          echo ""

          SUCCESS_COUNT=0
          SKIP_COUNT=0
          FAIL_COUNT=0

          # åˆ†å‰²å­¸æœŸå­—ä¸²ä¸¦é€å€‹è™•ç†
          IFS=',' read -ra SEMESTER_LIST <<< "$SEMESTERS"

          for semester in "${SEMESTER_LIST[@]}"; do
            # ç§»é™¤ç©ºç™½
            semester=$(echo "$semester" | xargs)

            # è§£æå­¸å¹´å’Œå­¸æœŸ
            YEAR=$(echo "$semester" | cut -d'-' -f1)
            TERM=$(echo "$semester" | cut -d'-' -f2)

            echo "========================================="
            echo "ğŸ“š è™•ç†: $YEAR å­¸å¹´åº¦ç¬¬ $TERM å­¸æœŸ"
            echo "========================================="

            # æª¢æŸ¥æ˜¯å¦å·²æœ‰è³‡æ–™
            EXISTING=$(psql "$DATABASE_URL" -t -c "
              SELECT COUNT(*)
              FROM \"Course\"
              WHERE year = '$YEAR' AND term = '$TERM';
            " | tr -d ' ')

            if [ "$EXISTING" -gt 0 ]; then
              echo "â­ï¸  å·²å­˜åœ¨ $EXISTING ç­†è³‡æ–™ï¼Œè·³é"
              SKIP_COUNT=$((SKIP_COUNT + 1))
              echo ""
              continue
            fi

            # çˆ¬å–è³‡æ–™
            echo "ğŸ•·ï¸  é–‹å§‹çˆ¬å–..."
            if NKUST_IMPORT_YEAR=$YEAR NKUST_IMPORT_TERM=$TERM npm run scrape:nkust-ag202; then
              echo "âœ“ çˆ¬å–å®Œæˆ"
            else
              echo "âŒ çˆ¬å–å¤±æ•—"
              FAIL_COUNT=$((FAIL_COUNT + 1))
              echo ""
              continue
            fi

            # åŒ¯å…¥è³‡æ–™åº«
            echo "ğŸ’¾ é–‹å§‹åŒ¯å…¥..."
            if NKUST_IMPORT_YEAR=$YEAR NKUST_IMPORT_TERM=$TERM npm run db:import:nkust-ag202; then
              echo "âœ“ åŒ¯å…¥å®Œæˆ"

              # é©—è­‰
              NEW_COUNT=$(psql "$DATABASE_URL" -t -c "
                SELECT COUNT(*)
                FROM \"Course\"
                WHERE year = '$YEAR' AND term = '$TERM';
              " | tr -d ' ')

              echo "ğŸ“ˆ æ–°å¢èª²ç¨‹: $NEW_COUNT"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "âŒ åŒ¯å…¥å¤±æ•—"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi

            echo ""
          done

          # æœ€çµ‚çµ±è¨ˆ
          echo "========================================="
          echo "ğŸ“Š æ‰¹æ¬¡åŒ¯å…¥å®Œæˆ"
          echo "========================================="
          echo "ç¸½å­¸æœŸæ•¸: ${{ steps.parse.outputs.count }}"
          echo "æˆåŠŸ: $SUCCESS_COUNT"
          echo "è·³é: $SKIP_COUNT"
          echo "å¤±æ•—: $FAIL_COUNT"
          echo ""

          # æŸ¥è©¢ç¸½è³‡æ–™é‡
          TOTAL_COURSES=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM \"Course\";" | tr -d ' ')
          TOTAL_INSTRUCTORS=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM \"Instructor\";" | tr -d ' ')

          echo "è³‡æ–™åº«ç¸½è¨ˆï¼š"
          echo "  èª²ç¨‹ç¸½æ•¸: $TOTAL_COURSES"
          echo "  æ•™å¸«ç¸½æ•¸: $TOTAL_INSTRUCTORS"

          # æŒ‰å­¸æœŸçµ±è¨ˆ
          echo ""
          echo "å„å­¸æœŸèª²ç¨‹æ•¸ï¼š"
          psql "$DATABASE_URL" -c "
            SELECT year || ' å­¸å¹´åº¦ç¬¬ ' || term || ' å­¸æœŸ' as semester,
                   COUNT(*) as courses
            FROM \"Course\"
            GROUP BY year, term
            ORDER BY year DESC, term DESC;
          "

          # å¦‚æœæœ‰å¤±æ•—ï¼Œé€€å‡ºç¢¼è¨­ç‚º 1
          if [ "$FAIL_COUNT" -gt 0 ]; then
            exit 1
          fi

      - name: ğŸ“‹ Summary
        if: always()
        run: |
          echo "æ‰¹æ¬¡åŒ¯å…¥ä»»å‹™å®Œæˆ"
          echo "è«‹æŸ¥çœ‹ä¸Šæ–¹æ—¥èªŒäº†è§£è©³ç´°çµæœ"
