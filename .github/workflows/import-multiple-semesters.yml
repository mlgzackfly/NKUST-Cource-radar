name: Import Multiple Semesters

on:
  workflow_dispatch:
    inputs:
      semesters:
        description: 'è¦åŒ¯å…¥çš„å­¸æœŸï¼ˆæ ¼å¼: 113-1,113-2,114-1ï¼‰'
        required: true
        default: '114-1'
        type: string
      scrape_syllabus:
        description: 'æ˜¯å¦çˆ¬å–èª²ç¨‹å¤§ç¶± (æœƒå¢åŠ  3-5 å€æ™‚é–“)'
        required: false
        default: false
        type: boolean
      skip_existing:
        description: 'è·³éå·²å­˜åœ¨çš„å­¸æœŸ'
        required: false
        default: true
        type: boolean

jobs:
  # ç¬¬ä¸€å€‹ jobï¼šè§£æå­¸æœŸåˆ—è¡¨ï¼Œç”Ÿæˆ matrix
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      count: ${{ steps.set-matrix.outputs.count }}
    steps:
      - name: ğŸ“‹ Parse semesters into matrix
        id: set-matrix
        run: |
          SEMESTERS="${{ inputs.semesters }}"

          # å°‡é€—è™Ÿåˆ†éš”çš„å­¸æœŸè½‰æ›ç‚º JSON array
          JSON_ARRAY=$(echo "$SEMESTERS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "matrix={\"semester\":$JSON_ARRAY}" >> $GITHUB_OUTPUT

          COUNT=$(echo "$JSON_ARRAY" | jq '. | length')
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          echo "æº–å‚™åŒ¯å…¥ $COUNT å€‹å­¸æœŸ"
          echo "Matrix: $JSON_ARRAY"

  # ç¬¬äºŒå€‹ jobï¼šä¸¦è¡Œè™•ç†æ¯å€‹å­¸æœŸ
  import:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 180  # æ¯å€‹å­¸æœŸæœ€å¤š 3 å°æ™‚
    strategy:
      fail-fast: false  # ä¸€å€‹å¤±æ•—ä¸å½±éŸ¿å…¶ä»–
      max-parallel: 3   # æœ€å¤šåŒæ™‚åŸ·è¡Œ 3 å€‹
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ“š Parse semester
        id: parse
        run: |
          SEMESTER="${{ matrix.semester }}"
          YEAR=$(echo "$SEMESTER" | cut -d'-' -f1)
          TERM=$(echo "$SEMESTER" | cut -d'-' -f2)

          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "term=$TERM" >> $GITHUB_OUTPUT
          echo "è™•ç†: $YEAR å­¸å¹´åº¦ç¬¬ $TERM å­¸æœŸ"

      - name: ğŸ” Check existing data
        id: check
        if: ${{ inputs.skip_existing }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          YEAR="${{ steps.parse.outputs.year }}"
          TERM="${{ steps.parse.outputs.term }}"

          EXISTING=$(psql "$DATABASE_URL" -t -c "
            SELECT COUNT(*)
            FROM \"Course\"
            WHERE year = '$YEAR' AND term = '$TERM';
          " | tr -d ' ')

          echo "existing=$EXISTING" >> $GITHUB_OUTPUT

          if [ "$EXISTING" -gt 0 ]; then
            echo "â­ï¸ å·²å­˜åœ¨ $EXISTING ç­†è³‡æ–™"
          fi

      - name: ğŸ•·ï¸ Scrape data
        if: ${{ !inputs.skip_existing || steps.check.outputs.existing == '0' }}
        env:
          NKUST_AG202_YMS_YMS: "${{ steps.parse.outputs.year }}#${{ steps.parse.outputs.term }}"
          NKUST_SCRAPE_SYLLABUS: ${{ inputs.scrape_syllabus && '1' || '' }}
        run: |
          echo "ğŸ•·ï¸ é–‹å§‹çˆ¬å– ${{ matrix.semester }}..."
          npm run scrape:nkust-ag202
          echo "âœ“ çˆ¬å–å®Œæˆ"

      - name: ğŸ’¾ Import to database
        if: ${{ !inputs.skip_existing || steps.check.outputs.existing == '0' }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NKUST_IMPORT_YEAR: ${{ steps.parse.outputs.year }}
          NKUST_IMPORT_TERM: ${{ steps.parse.outputs.term }}
        run: |
          echo "ğŸ’¾ é–‹å§‹åŒ¯å…¥..."
          npm run db:import:nkust-ag202
          echo "âœ“ åŒ¯å…¥å®Œæˆ"

      - name: ğŸ“Š Verify import
        if: ${{ !inputs.skip_existing || steps.check.outputs.existing == '0' }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          YEAR="${{ steps.parse.outputs.year }}"
          TERM="${{ steps.parse.outputs.term }}"

          COUNT=$(psql "$DATABASE_URL" -t -c "
            SELECT COUNT(*)
            FROM \"Course\"
            WHERE year = '$YEAR' AND term = '$TERM';
          " | tr -d ' ')

          echo "ğŸ“ˆ ${{ matrix.semester }} åŒ¯å…¥èª²ç¨‹æ•¸: $COUNT"

      - name: â­ï¸ Skip message
        if: ${{ inputs.skip_existing && steps.check.outputs.existing != '0' }}
        run: |
          echo "â­ï¸ è·³é ${{ matrix.semester }}ï¼Œå·²å­˜åœ¨ ${{ steps.check.outputs.existing }} ç­†è³‡æ–™"

  # ç¬¬ä¸‰å€‹ jobï¼šçµ±è¨ˆçµæœ
  summary:
    needs: [prepare, import]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“Š Final Summary
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "========================================="
          echo "ğŸ“Š æ‰¹æ¬¡åŒ¯å…¥å®Œæˆ"
          echo "========================================="
          echo "è™•ç†å­¸æœŸæ•¸: ${{ needs.prepare.outputs.count }}"
          echo ""

          # æŸ¥è©¢ç¸½è³‡æ–™é‡
          TOTAL_COURSES=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM \"Course\";" | tr -d ' ')
          TOTAL_INSTRUCTORS=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM \"Instructor\";" | tr -d ' ')

          echo "è³‡æ–™åº«ç¸½è¨ˆï¼š"
          echo "  èª²ç¨‹ç¸½æ•¸: $TOTAL_COURSES"
          echo "  æ•™å¸«ç¸½æ•¸: $TOTAL_INSTRUCTORS"
          echo ""

          # æŒ‰å­¸æœŸçµ±è¨ˆ
          echo "å„å­¸æœŸèª²ç¨‹æ•¸ï¼š"
          psql "$DATABASE_URL" -c "
            SELECT year || '-' || term as semester,
                   COUNT(*) as courses
            FROM \"Course\"
            GROUP BY year, term
            ORDER BY year DESC, term DESC
            LIMIT 20;
          "
