name: Scrape Course Syllabus

on:
  workflow_dispatch:
    inputs:
      year:
        description: 'å­¸å¹´åº¦ (ä¾‹å¦‚: 114)'
        required: true
        default: '114'
        type: string
      term:
        description: 'å­¸æœŸ'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

jobs:
  scrape-syllabus:
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5 å°æ™‚è¶…æ™‚é™åˆ¶

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ•·ï¸ Scrape courses with syllabus
        env:
          NKUST_AG202_YMS_YMS: ${{ inputs.year }}#${{ inputs.term }}
          NKUST_SCRAPE_SYLLABUS: '1'
        run: |
          echo "ğŸ“š é–‹å§‹çˆ¬å– ${{ inputs.year }} å­¸å¹´åº¦ç¬¬ ${{ inputs.term }} å­¸æœŸèª²ç¨‹ï¼ˆå«èª²ç¶±ï¼‰..."
          npm run scrape:nkust-ag202
          echo "âœ“ çˆ¬å–å®Œæˆ"

      - name: ğŸ“¥ Import to database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NKUST_IMPORT_YEAR: ${{ inputs.year }}
          NKUST_IMPORT_TERM: ${{ inputs.term }}
        run: |
          echo "ğŸ’¾ é–‹å§‹åŒ¯å…¥è³‡æ–™åº«..."
          npm run db:import:nkust-ag202
          echo "âœ“ åŒ¯å…¥å®Œæˆ"

      - name: ğŸ“Š Verify import
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          YEAR=${{ inputs.year }}
          TERM=${{ inputs.term }}

          echo "æ­£åœ¨é©—è­‰åŒ¯å…¥çµæœ..."

          COURSE_COUNT=$(psql "$DATABASE_URL" -t -c "
            SELECT COUNT(*)
            FROM \"Course\"
            WHERE year = '$YEAR' AND term = '$TERM';
          " | tr -d ' ')

          echo "ğŸ“ˆ åŒ¯å…¥çµ±è¨ˆï¼š"
          echo "  å­¸æœŸ: $YEAR å­¸å¹´åº¦ç¬¬ $TERM å­¸æœŸ"
          echo "  èª²ç¨‹æ•¸: $COURSE_COUNT"

          if [ "$COURSE_COUNT" -lt 100 ]; then
            echo "âŒ èª²ç¨‹æ•¸é‡ç•°å¸¸åä½ï¼Œå¯èƒ½åŒ¯å…¥å¤±æ•—"
            exit 1
          fi

          echo "âœ… é©—è­‰é€šé"

      - name: ğŸ“‹ Summary
        if: always()
        run: |
          echo "âœ… å®ŒæˆåŒ¯å…¥ï¼š${{ inputs.year }} å­¸å¹´åº¦ç¬¬ ${{ inputs.term }} å­¸æœŸï¼ˆå«èª²ç¶±ï¼‰"
