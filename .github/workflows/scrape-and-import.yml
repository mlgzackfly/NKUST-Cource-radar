name: Scrape and Import Course Data

on:
  # 手動觸發
  workflow_dispatch:
    inputs:
      year:
        description: "學年度 (e.g., 114)"
        required: true
        default: "114"
      term:
        description: "學期 (1=上學期, 2=下學期)"
        required: true
        default: "1"
        type: choice
        options:
          - "1"
          - "2"

  # 排程執行：每學期開學前自動執行
  # 上學期：8月1日  (暑假結束前)
  # 下學期：1月15日 (寒假結束前)
  schedule:
    - cron: "0 0 1 8 *"   # 8月1日 00:00 UTC (上學期)
    - cron: "0 0 15 1 *"  # 1月15日 00:00 UTC (下學期)

permissions:
  contents: write

jobs:
  scrape-and-import:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Determine semester
        id: semester
        run: |
          # 從手動輸入或當前日期判斷學期
          if [ -n "${{ inputs.year }}" ]; then
            YEAR="${{ inputs.year }}"
            TERM="${{ inputs.term }}"
          else
            # 自動判斷當前學期
            MONTH=$(date +%m)
            if [ $MONTH -ge 8 ]; then
              # 8-12月為上學期
              YEAR=$(date +%Y | awk '{print $1-1911}')  # 轉換為民國年
              TERM="1"
            else
              # 1-7月為下學期
              YEAR=$(date +%Y | awk '{print $1-1912}')
              TERM="2"
            fi
          fi
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "term=$TERM" >> $GITHUB_OUTPUT
          echo "學期: $YEAR-$TERM"

      - name: Scrape course data
        run: npm run scrape:nkust-ag202
        env:
          NKUST_AG202_YMS_YMS: "${{ steps.semester.outputs.year }}#${{ steps.semester.outputs.term }}"
          NKUST_AG202_CMP_AREA_ID: "0"
          NKUST_AG202_DGR_ID: "ALL"
          NKUST_AG202_SCRAPE_ALL_UNITS: "1"

      - name: Import to database
        run: npm run db:import:nkust-ag202
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Commit scraped data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git add data/nkust/ag202
            git commit -m "chore: update course data for ${{ steps.semester.outputs.year }}-${{ steps.semester.outputs.term }}"
            git push
          fi

      - name: Notify completion
        if: always()
        run: |
          echo "✅ 爬蟲和匯入完成！"
          echo "學期: ${{ steps.semester.outputs.year }}-${{ steps.semester.outputs.term }}"
          echo "狀態: ${{ job.status }}"
