name: Import Course Data

on:
  # æ‰‹å‹•è§¸ç™¼ï¼Œå¯é¸æ“‡å­¸æœŸ
  workflow_dispatch:
    inputs:
      year:
        description: 'å­¸å¹´åº¦ (ä¾‹å¦‚: 114)'
        required: true
        default: '114'
        type: string
      term:
        description: 'å­¸æœŸ (1 æˆ– 2)'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
      scrape_syllabus:
        description: 'æ˜¯å¦çˆ¬å–èª²ç¨‹å¤§ç¶± (æœƒå¢åŠ  3-5 å€æ™‚é–“)'
        required: false
        default: false
        type: boolean

  # å®šæ™‚åŸ·è¡Œï¼šæ¯å­¸æœŸé–‹å§‹æ™‚è‡ªå‹•çˆ¬å–ï¼ˆ2 æœˆå’Œ 9 æœˆçš„ç¬¬ä¸€å¤©ï¼‰
  schedule:
    # æ¯å¹´ 2 æœˆ 1 æ—¥å‡Œæ™¨ 2 é» (UTC)ï¼Œçˆ¬å–ä¸Šå­¸æœŸè³‡æ–™
    - cron: '0 2 1 2 *'
    # æ¯å¹´ 9 æœˆ 1 æ—¥å‡Œæ™¨ 2 é» (UTC)ï¼Œçˆ¬å–æœ¬å­¸æœŸè³‡æ–™
    - cron: '0 2 1 9 *'

jobs:
  import-data:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 å°æ™‚è¶…æ™‚é™åˆ¶

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ¯ Set semester variables
        id: semester
        run: |
          # å¦‚æœæ˜¯æ‰‹å‹•è§¸ç™¼ï¼Œä½¿ç”¨è¼¸å…¥çš„åƒæ•¸
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "year=${{ inputs.year }}" >> $GITHUB_OUTPUT
            echo "term=${{ inputs.term }}" >> $GITHUB_OUTPUT
            echo "scrape_syllabus=${{ inputs.scrape_syllabus }}" >> $GITHUB_OUTPUT
          else
            # å®šæ™‚ä»»å‹™ï¼šæ ¹æ“šæœˆä»½æ±ºå®šå­¸æœŸ
            MONTH=$(date +%m)
            YEAR=$(date +%Y)

            if [ "$MONTH" = "02" ]; then
              # 2 æœˆçˆ¬å–ä¸Šå­¸æœŸ (å»å¹´åº¦ç¬¬ 1 å­¸æœŸ)
              ACADEMIC_YEAR=$((YEAR - 1912 - 1))
              TERM="1"
            else
              # 9 æœˆçˆ¬å–æœ¬å­¸æœŸ (æœ¬å¹´åº¦ç¬¬ 1 å­¸æœŸ)
              ACADEMIC_YEAR=$((YEAR - 1911))
              TERM="1"
            fi

            echo "year=$ACADEMIC_YEAR" >> $GITHUB_OUTPUT
            echo "term=$TERM" >> $GITHUB_OUTPUT
            echo "scrape_syllabus=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Check existing data
        id: check
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          YEAR=${{ steps.semester.outputs.year }}
          TERM=${{ steps.semester.outputs.term }}

          echo "æ­£åœ¨æª¢æŸ¥ $YEAR å­¸å¹´åº¦ç¬¬ $TERM å­¸æœŸçš„ç¾æœ‰è³‡æ–™..."

          COUNT=$(psql "$DATABASE_URL" -t -c "
            SELECT COUNT(*)
            FROM \"Course\"
            WHERE year = '$YEAR' AND term = '$TERM';
          " | tr -d ' ')

          echo "existing_count=$COUNT" >> $GITHUB_OUTPUT

          if [ "$COUNT" -gt 0 ]; then
            echo "âš ï¸  å·²å­˜åœ¨ $COUNT ç­†èª²ç¨‹è³‡æ–™"
            echo "should_skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ“ å°šç„¡è³‡æ–™ï¼Œæº–å‚™çˆ¬å–"
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ•·ï¸ Scrape course data
        if: steps.check.outputs.should_skip != 'true'
        env:
          NKUST_AG202_YMS_YMS: ${{ steps.semester.outputs.year }}#${{ steps.semester.outputs.term }}
          NKUST_IMPORT_YEAR: ${{ steps.semester.outputs.year }}
          NKUST_IMPORT_TERM: ${{ steps.semester.outputs.term }}
          NKUST_SCRAPE_SYLLABUS: ${{ steps.semester.outputs.scrape_syllabus }}
        run: |
          echo "ğŸ“š é–‹å§‹çˆ¬å– $NKUST_IMPORT_YEAR å­¸å¹´åº¦ç¬¬ $NKUST_IMPORT_TERM å­¸æœŸèª²ç¨‹..."
          echo "çˆ¬å–èª²ç¨‹å¤§ç¶±: $NKUST_SCRAPE_SYLLABUS"

          npm run scrape:nkust-ag202

          echo "âœ“ çˆ¬å–å®Œæˆ"

      - name: ğŸ“¥ Import to database
        if: steps.check.outputs.should_skip != 'true'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NKUST_IMPORT_YEAR: ${{ steps.semester.outputs.year }}
          NKUST_IMPORT_TERM: ${{ steps.semester.outputs.term }}
        run: |
          echo "ğŸ’¾ é–‹å§‹åŒ¯å…¥è³‡æ–™åº«..."

          npm run db:import:nkust-ag202

          echo "âœ“ åŒ¯å…¥å®Œæˆ"

      - name: ğŸ“Š Verify import
        if: steps.check.outputs.should_skip != 'true'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          YEAR=${{ steps.semester.outputs.year }}
          TERM=${{ steps.semester.outputs.term }}

          echo "æ­£åœ¨é©—è­‰åŒ¯å…¥çµæœ..."

          # æŸ¥è©¢åŒ¯å…¥çš„èª²ç¨‹æ•¸é‡
          COURSE_COUNT=$(psql "$DATABASE_URL" -t -c "
            SELECT COUNT(*)
            FROM \"Course\"
            WHERE year = '$YEAR' AND term = '$TERM';
          " | tr -d ' ')

          # æŸ¥è©¢æ•™å¸«æ•¸é‡
          INSTRUCTOR_COUNT=$(psql "$DATABASE_URL" -t -c "
            SELECT COUNT(DISTINCT ci.\"instructorId\")
            FROM \"CourseInstructor\" ci
            JOIN \"Course\" c ON c.id = ci.\"courseId\"
            WHERE c.year = '$YEAR' AND c.term = '$TERM';
          " | tr -d ' ')

          echo "ğŸ“ˆ åŒ¯å…¥çµ±è¨ˆï¼š"
          echo "  å­¸æœŸ: $YEAR å­¸å¹´åº¦ç¬¬ $TERM å­¸æœŸ"
          echo "  èª²ç¨‹æ•¸: $COURSE_COUNT"
          echo "  æ•™å¸«æ•¸: $INSTRUCTOR_COUNT"

          if [ "$COURSE_COUNT" -lt 100 ]; then
            echo "âŒ èª²ç¨‹æ•¸é‡ç•°å¸¸åä½ï¼Œå¯èƒ½åŒ¯å…¥å¤±æ•—"
            exit 1
          fi

          echo "âœ… é©—è­‰é€šé"

      - name: ğŸ“‹ Summary
        if: always()
        run: |
          YEAR=${{ steps.semester.outputs.year }}
          TERM=${{ steps.semester.outputs.term }}

          if [ "${{ steps.check.outputs.should_skip }}" = "true" ]; then
            echo "â­ï¸  è·³éåŒ¯å…¥ï¼š$YEAR å­¸å¹´åº¦ç¬¬ $TERM å­¸æœŸå·²æœ‰ ${{ steps.check.outputs.existing_count }} ç­†è³‡æ–™"
          else
            echo "âœ… å®ŒæˆåŒ¯å…¥ï¼š$YEAR å­¸å¹´åº¦ç¬¬ $TERM å­¸æœŸ"
          fi

      - name: ğŸ”” Notify on failure
        if: failure()
        run: |
          echo "âŒ åŒ¯å…¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹åŸ·è¡Œæ—¥èªŒ"
          echo "å­¸æœŸ: ${{ steps.semester.outputs.year }} å­¸å¹´åº¦ç¬¬ ${{ steps.semester.outputs.term }} å­¸æœŸ"
