generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ReviewStatus {
  ACTIVE
  HIDDEN
  REMOVED
}

enum ReportStatus {
  OPEN
  RESOLVED
  REJECTED
}

enum AdminActionType {
  HIDE_REVIEW
  UNHIDE_REVIEW
  REMOVE_REVIEW
  BAN_USER
  REQUEST_EDIT
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum UserRole {
  USER
  ADMIN
}

enum TagCategory {
  CONTENT      // 內容類型
  DIFFICULTY   // 難度
  TEACHING     // 教學風格
  WORKLOAD     // 作業量
  GRADING      // 給分
  SPECIALTY    // 特色
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime? // Required by NextAuth
  name          String?   // Optional for NextAuth
  image         String?   // Optional for NextAuth
  createdAt     DateTime  @default(now())
  bannedAt      DateTime?
  role          UserRole  @default(USER)

  // NextAuth relations
  accounts      Account[]
  sessions      Session[]

  // relations
  reviews       Review[]
  helpfulVotes  HelpfulVote[]
  comments      Comment[]
  reports       Report[]
  favorites     Favorite[]
  interactions  UserInteraction[]
  recommendations RecommendationCache[]
  adminActions  AdminAction[] @relation("AdminActor")
  adminActionsAsTarget AdminAction[] @relation("AdminTargetUser")
}

model Course {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Stable key for idempotent imports (derived from source request + selectCode/courseCode)
  sourceKey String @unique

  // Source fields (from nkust ag202)
  year      String
  term      String
  campus    String?
  division  String?
  degreeId  String? // dgr_id
  campusId  String? // cmp_area_id
  unitId    String? // unt_id
  department String?

  selectCode String?
  courseCode String?
  courseName String
  className  String?
  combinedClassName String?

  credits      Float?
  lectureHours Float?
  labHours     Float?
  requiredOrElective String?

  classroom String?
  time      String?

  enrolled Int?
  capacity Int?

  englishTaught     String?
  distanceLearning  String?
  note              String?

  // Syllabus (授課大綱)
  syllabusUrl       String? // URL to fetch syllabus
  syllabusHtml      String? // Raw HTML content
  syllabusData      Json?   // Parsed structured data

  // Full-text search vector (populated by trigger)
  searchVector Unsupported("tsvector")?

  // relations
  instructors CourseInstructor[]
  reviews      Review[]
  favorites    Favorite[]
  tags         CourseTag[]
  interactions UserInteraction[]
  recommendations RecommendationCache[]

  @@index([year, term])
  @@index([updatedAt])
  @@index([courseName])
  @@index([courseCode])
  @@index([selectCode])
  @@index([campus])
  @@index([division])
  @@index([department])
  @@index([year, term, department])
  @@index([year, term, campus])
  @@index([searchVector], map: "Course_searchVector_idx", type: Gin)
}

model Instructor {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  courses CourseInstructor[]

  @@index([name])
  @@unique([name])
}

model CourseInstructor {
  courseId     String
  instructorId String
  role         String? // future use

  course     Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructor Instructor @relation(fields: [instructorId], references: [id], onDelete: Cascade)

  @@id([courseId, instructorId])
}

model Review {
  id        String      @id @default(cuid())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  status    ReviewStatus @default(ACTIVE)

  // ownership (not exposed publicly)
  userId   String
  courseId String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // current content
  coolness     Int? // 1-5 or null (N/A)
  usefulness   Int?
  workload     Int?
  attendance   Int?
  grading      Int? // 給分甜度 (1-5 or null)
  body         String?
  authorDept   String? // displayed; still anonymous

  // relations
  versions      ReviewVersion[]
  comments      Comment[]
  helpfulVotes  HelpfulVote[]
  reports       Report[]
  adminActionsAsTarget AdminAction[] @relation("AdminTargetReview")

  @@unique([userId, courseId]) // one user one review per course
  @@index([courseId, createdAt])
}

model ReviewVersion {
  id        String   @id @default(cuid())
  reviewId  String
  createdAt DateTime @default(now())

  // snapshot
  coolness     Int?
  usefulness   Int?
  workload     Int?
  attendance   Int?
  grading      Int?
  body         String?
  authorDept   String?

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId, createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviewId String
  userId   String
  body     String

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([reviewId, createdAt])
}

model HelpfulVote {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  voteType  VoteType @default(UPVOTE)

  reviewId String
  userId   String

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@index([reviewId, voteType])
}

model Favorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId   String
  courseId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId, createdAt])
  @@index([courseId])
}

model Report {
  id        String       @id @default(cuid())
  createdAt DateTime     @default(now())
  status    ReportStatus @default(OPEN)

  reviewId String
  userId   String
  reason   String

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId, createdAt])
}

model AdminAction {
  id        String          @id @default(cuid())
  createdAt DateTime        @default(now())
  type      AdminActionType
  note      String?

  actorId String
  actor   User @relation("AdminActor", fields: [actorId], references: [id], onDelete: Cascade)

  targetUserId  String?
  targetUser    User? @relation("AdminTargetUser", fields: [targetUserId], references: [id], onDelete: SetNull)

  targetReviewId String?
  targetReview   Review? @relation("AdminTargetReview", fields: [targetReviewId], references: [id], onDelete: SetNull)

  @@index([type, createdAt])
}

// NextAuth.js models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ===== Phase 2: 標籤與推薦系統 =====

model Tag {
  id        String      @id @default(cuid())
  name      String      @unique
  category  TagCategory
  color     String?
  createdAt DateTime    @default(now())

  courseTags CourseTag[]

  @@index([category])
}

model CourseTag {
  courseId  String
  tagId     String
  score     Float   @default(1.0)  // 標籤相關性分數
  source    String  @default("AUTO")  // AUTO | MANUAL | USER_VOTE
  createdAt DateTime @default(now())

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([courseId, tagId])
  @@index([tagId, score])
}

model UserInteraction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  courseId  String
  type      String   // VIEW | REVIEW | FAVORITE | SEARCH
  weight    Float    @default(1.0)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([courseId, type])
}

model RecommendationCache {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  courseId  String
  score     Float
  reason    String   // COLLABORATIVE | CONTENT | TRENDING | PERSONALIZED
  expiresAt DateTime

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId, score])
  @@index([expiresAt])
}


